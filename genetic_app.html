<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Genetic app</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="styles/genetic_app.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a id="app-nav-header" class="navbar-brand" href="genetic_app.html">Genetic app</a>
        </div>
    </nav>
    <form id="tg_form">
        <div class="form-floating mb-3">
            <input class="form-control input" name="start_n" type="number" min="2" max="30" required placeholder="0" />
            <label>Initial number of individuals</label>
            <div class="form-text">
                Minimum 2, maximum 30
            </div>
        </div>
        <div class="form-floating mb-3">
            <input class="form-control input" name="max_n" type="number" min="4" max="45" required placeholder="0" />
            <label>Max number of individuals</label>
            <div class="form-text">
                Minimum 4, maximum 45
            </div>
        </div>
        <div class="form-floating mb-3">
            <input class="form-control input" name="number_by_crossing" type="number" min="0" max="30" required placeholder="0" />
            <label>Number of individuals generated by crossing-over</label>
            <div class="form-text">
                Each generation, minimum 0, maximum 30
            </div>
        </div>
        <div class="form-floating mb-3">
            <input class="form-control input" name="number_by_mutation" type="number" min="0" max="30" required placeholder="0" />
            <label>Number of individuals generated by mutation</label>
            <div class="form-text">
                Each generation, minimum 0, maximum 30
            </div>
        </div>
        <div class="form-floating mb-3">
            <input class="form-control input" name="number_by_cloning" type="number" min="0" max="30" required placeholder="0" />
            <label>Number of individuals generated by cloning</label>
            <div class="form-text">
                Each generation, minimum 0, maximum 30
            </div>
        </div>
        <div class="form-floating mb-3">
            <select id="tg_form_selected_function_id" class="form-select input" name="selected_function_id">
                <option value="0">time * cost</option>
                <option value="1">time</option>
                <option value="2">cost</option>
                <option value="3">cost + k*(time - tmax)</option>
            </select>
            <label>Function to minimize</label>
        </div>
        <div style="display: none;" id="function_3_parameters">
            <div class="form-floating mb-3">
                <input class="form-control input" name="tmax" type="number" min="0" step="any" placeholder="0" />
                <label>tmax</label>
                <div class="form-text">
                    Maximum time (time constraint)
                </div>
            </div>
            <div class="form-floating mb-3">
                <input class="form-control input" name="k" type="number" min="0" step="any" placeholder="0" />
                <label>k</label>
            </div>
        </div>
        <div class="form-check mb-3">
            <label for="include_fastest_cheapest">Include the fastest and cheapest individuals</label>
            <input id="include_fastest_cheapest" class="form-check-input" name="include_fastest_cheapest" type="checkbox" />
        </div>
        <div class="form-floating mb-3">
            <textarea id="tg_form_tg_source_ta" class="form-control" name="tg_source" required>
@tasks 20
T0 5 1(0) 2(0) 3(0) 4(0) 5(0)   #This is a comment.
T1 0 
T2 5 6(0) 7(0) 8(0) 9(0) 12(0) 
T3 1 9(0) 
T4 0 
T5 2 18(0) 19(0) 
T6 1 9(0) 
T7 0 
T8 2 10(0) 11(0) 
T9 0 
T10 0 
T11 0 
T12 5 13(0) 14(0) 15(0) 16(0) 17(0) 
T13 0 
T14 0 
T15 0 
T16 0 
T17 0 
T18 0 
T19 0 
@proc 4
285 0 1 
118 0 1 
0 0 0 
0 0 0 
@times 
841 693 65 58 
646 595 70 42 
776 637 6 22 
663 335 57 54 
714 785 76 70 
729 684 69 15 
662 55 27 66 
71 897 64 51 
697 868 46 36 
350 923 3 26 
60 679 30 27 
536 337 50 69 
636 587 43 51 
388 519 27 16 
270 852 81 17 
432 752 9 55 
693 76 70 6 
412 805 32 53 
692 636 34 15 
824 511 69 11 
@cost 
5 40 328 293 
48 54 104 46 
10 11 142 405 
7 69 255 183 
61 24 265 319 
31 5 47 392 
12 97 260 330 
71 36 76 111 
54 53 225 370 
55 48 75 385 
56 17 350 145 
42 67 364 99 
17 22 273 175 
8 23 157 213 
66 56 209 253 
14 47 459 159 
38 65 280 153 
19 32 73 367 
12 60 219 345 
25 2 257 178 
@comm 1
CHAN0 59 10 1 1 1 1 
            </textarea>
            <label>Task graph</label>
        </div>
        <button type="submit" class="btn btn-primary">Start genetic</button>
    </form>

    <div id="genetic_app_root" style="display: none;">
        <button type="button" id="start_over_button" class="btn btn-primary">Start over</button>
        <hr />
        <div>
            <div>
                <div name="genetic"></div>
            </div>
            <div>
                <div name="system_description"></div>
                <div id="gantt"></div>
            </div>
        </div>
    </div>

    <script type="module">
        console.log("Hello world");

        import {readTaskGraph} from "./task_graph.js";
        import {GeneticApp} from "./genetic_app.js";

        let tg_form = document.getElementById("tg_form");
        let genetic_app_root = document.getElementById("genetic_app_root");
        let start_over_button = document.getElementById("start_over_button");
        
        let function_select = document.getElementById("tg_form_selected_function_id");
        let function_3_parameters = document.getElementById("function_3_parameters");
        
        function_select.onchange = function(){
            let v = Number.parseInt(function_select.value);
            if(v===3 && function_3_parameters.style.display=="none"){
                function_3_parameters.style.display = null;
                for(let input of function_3_parameters.querySelectorAll("input")){
                    input.setAttribute('required', '');
                }
            }
            else if(function_3_parameters.style.display !== "none"){
                function_3_parameters.style.display = "none";
                for(let input of function_3_parameters.querySelectorAll("input")){
                    input.removeAttribute('required', '');
                }
            }
        }

        let app = null;

        start_over_button.onclick = function(){
            if(confirm("Are you sure to start over?")){
                tg_form.style.display = null;
                genetic_app_root.style.display = "none";

                app.clear();
                app = null;
            }
        }

        tg_form.onsubmit = function(event){
            event.preventDefault();
            let fd = new FormData(event.target);
            let tg_source = fd.get("tg_source");

            let task_graph = null;
            try{
                task_graph = readTaskGraph(tg_source);
            }
            catch(e){
                alert(e);
                return;
            }

            let start_n = Number.parseInt(fd.get("start_n"));
            let max_n = Number.parseInt(fd.get("max_n"));
            let number_by_crossing = Number.parseInt(fd.get("number_by_crossing"));
            let number_by_mutation = Number.parseInt(fd.get("number_by_mutation"));
            let number_by_cloning = Number.parseInt(fd.get("number_by_cloning"));

            let score_func = null;
            let selected_function_id = Number.parseInt(fd.get("selected_function_id"));

            let include_fastest_cheapest = fd.get("include_fastest_cheapest") === "on";

            let score_func_name = function_select.options[function_select.selectedIndex].text;

            switch(selected_function_id){
            case 0:
                score_func = function(time, cost){
                    return time * cost;
                }
                break;
            case 1:
                score_func = function(time, cost){
                    return time;
                }
                break;
            case 2:
                score_func = function(time, cost){
                    return cost;
                }
                break;
            case 3:
                let k = Number.parseFloat(fd.get("k"));
                let tmax = Number.parseFloat(fd.get("tmax"));
                score_func = function(time, cost){
                    return cost + k*(time - tmax);
                }
                score_func_name = `cost + ${k}*(time - ${tmax})`;
                break;
            }

            app = new GeneticApp(genetic_app_root, task_graph, score_func, score_func_name, start_n, max_n,
            number_by_crossing, number_by_mutation, number_by_cloning, include_fastest_cheapest);

            app.render();

            tg_form.style.display = "none";
            genetic_app_root.style.display = null;
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
</body>
</html>